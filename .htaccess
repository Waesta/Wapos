# WAPOS Apache Configuration
# Performance and Security Optimization

# Disable server signature
ServerSignature Off

# Enable Gzip Compression for static assets only
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# Prevent caching of PHP files (dynamic content)
<FilesMatch "\.(php)$">
    Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header set Pragma "no-cache"
    Header set Expires "Sat, 01 Jan 2000 00:00:00 GMT"
</FilesMatch>

# Cache static assets (CSS, JS, Images) for 1 hour only
<FilesMatch "\.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$">
    Header set Cache-Control "public, max-age=3600"
</FilesMatch>

# Security Headers - Enhanced
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set X-XSS-Protection "1; mode=block"
    # Enable after HTTPS:
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Content Security Policy
    Header set Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; script-src 'self' https://cdn.jsdelivr.net; font-src 'self' https://cdn.jsdelivr.net data:; connect-src 'self'; manifest-src 'self';"
</IfModule>

# Disable directory browsing
Options -Indexes

# Enable URL rewriting
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /wapos/
    
    # Force HTTPS (uncomment in production)
    # RewriteCond %{HTTPS} off
    # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Prevent access to sensitive files and directories
    RewriteRule ^includes/ - [F,L]
    RewriteRule ^database/ - [F,L]
    RewriteRule ^cache/ - [F,L]
    RewriteRule ^logs/ - [F,L]
    RewriteRule ^app/ - [F,L]
    RewriteRule ^config/ - [F,L]
    RewriteRule ^vendor/ - [F,L]
    RewriteRule \.sql$ - [F,L]
    RewriteRule \.md$ - [F,L]
    RewriteRule \.txt$ - [F,L]
    RewriteRule ^\.git - [F,L]
</IfModule>

# Block access to sensitive file types
<FilesMatch "\\.(sql|md|yml|yaml|ini|log|zip|bak)$">
    Require all denied
</FilesMatch>

# Block access to .git directory
RedirectMatch 404 ^/.git

# Block access to specific directories
RedirectMatch 404 ^/database
RedirectMatch 404 ^/cache$
RedirectMatch 404 ^/cache/
RedirectMatch 404 ^/app
RedirectMatch 404 ^/config

# Block access to installation and maintenance scripts (except admin migration tools)
<FilesMatch "^(install|setup|update|upgrade|emergency|test)-.*\\.php$">
    Require all denied
</FilesMatch>

# Allow admin migration scripts (protected by auth in the files themselves)
<FilesMatch "^(run-migration|run-migration-002|fix-migration-errors|fix-void-reason-codes|create-void-transactions|create-all-void-tables|quick-check-void-tables|FINAL_FIX_VOID_TABLES|add-affects-inventory-column|add-rider-location-columns)\.php$">
    Require all granted
</FilesMatch>

# PHP Settings
<IfModule mod_php.c>
    php_value session.cookie_httponly 1
    php_value session.cookie_secure 0
    php_value session.use_strict_mode 1
    php_value max_execution_time 60
    php_value max_input_time 60
    php_value memory_limit 256M
    php_value post_max_size 20M
    php_value upload_max_filesize 20M
</IfModule>

# Error pages
ErrorDocument 404 /wapos/404.php
ErrorDocument 403 /wapos/403.php
ErrorDocument 500 /wapos/500.php
